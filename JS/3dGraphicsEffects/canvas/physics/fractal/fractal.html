<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>フラクタルツリー</title>
	<meta name=viewport content="width=550">
	<style>
		body{background-color:black;}
		#wrap{width:500px;margin:10px auto;}
		#canvas{border:2px solid lightgreen;}
		input{width:100%;height:30px;display:block;}
		table{width:500px;border:1px solid white;}
		th,td,p{text-align:center;color:white;}
	</style>
</style>
<body>
	<div id="wrap">

		<canvas id=canvas width=500 height=500></canvas>
		<p>fractal</p>
		<table id=table>
			<tr>
				<th>枝の長さ</th>
				<td><input type=range min=0 max=160 value=80 step=1 id=len></td>
				<td id=lenValue>80px</td>
			</tr>
			<tr>
				<th>枝の比率</th>
				<td><input type=range min=0 max=1 value=0.7 step=0.1 id=scale></td>
				<td id=scaleValue>70%</td>
			</tr>
			<tr>
				<th>枝の広がり</th>
				<td><input type=range min=0 max=180 value=20 step=1 id=angle></td>
				<td id=angleValue>20度</td>
			</tr>
			<tr>
				<th>枝の段数</th>
				<td><input type=range min=1 max=14 value=8 id=step></td>
				<td id=stepValue>8段</td>
			</tr>
		</table>
	</div>
<script>
var canvas = $("canvas");
var c = canvas.getContext("2d");

//======================================================

//初期設定
var scale = 0.7	//枝の短くなる比率
var angle = 20;	//枝の広がり(度)
var len = 80;	//最初の枝の長さ(px)
var step = 8	//枝別れの段数
var x1=250;
var y1=380;
var deg=0;
var lenTarget=80;
var angleTarget=20;
var scaleTarget = 0.7;
var stepTarget = 8;
setInterval(start,50);

function start(){
	c.clearRect(0,0,canvas.width,canvas.height);
	
	if(len!=lenTarget){
		len+=(lenTarget-len)/Math.abs(lenTarget-len);
		$("lenValue").innerHTML=Math.floor(lenTarget)+"px";
		y1=300+len;
	}
	
	if(Math.abs(scale-scaleTarget)<0.01){
		scale=scaleTarget
	}else if(scale!=scaleTarget){
		scale+=(scaleTarget-scale)/Math.abs(scaleTarget-scale)*0.01;
		$("scaleValue").innerHTML=(scaleTarget*100)+"%";
		console.log(scale+","+scaleTarget);
		scale
	}
	if(angle!=angleTarget){
		angle+=(angleTarget-angle)/Math.abs(angleTarget-angle);
		$("angleValue").innerHTML=Math.floor(angleTarget)+"度";
	}

	if(step!=stepTarget){
		step+=(stepTarget-step)/Math.abs(stepTarget-step);
		$("stepValue").innerHTML=Math.floor(stepTarget)+"段";
	}
	
	fractal(x1,y1,len,deg,step);
}

//独自関数fractalの定義（x座標,y座標,長さ,角度,段数）
function fractal(x1,y1,len,deg,step) {
	var x2= x1+len*Math.sin(deg/180*Math.PI); //枝先のx座標
	var y2= y1-len*Math.cos(deg/180*Math.PI); //枝先のy座標
	line(x1,y1,x2,y2);
	if(step>=1) {  
		fractal(x2,y2,len*scale,deg-angle,step-1);	//自分自身を呼び出す
		fractal(x2,y2,len*scale,deg+angle,step-1);	//自分自身を呼び出す
	}
}

//独自関数line()の定義
function line(x1,y1,x2,y2){
	c.beginPath();
	c.moveTo(x1,y1)
	c.lineTo(x2,y2);
	c.lineWidth=2;
	c.lineCap="round";
	c.strokeStyle="yellow";
	c.stroke();
}

$("len").addEventListener("change",function(){lenTarget=$("len").value;})
$("scale").addEventListener("change",function(){scaleTarget=Math.floor($("scale").value*10)/10;})
$("angle").addEventListener("change",function(){angleTarget=$("angle").value;})
$("step").addEventListener("change",function(){stepTarget=$("step").value;})

function $(id){return document.getElementById(id);}

/*
$("canvas").addEventListener("touchmove",function(e){
	e.preventDefault();
});
*/

//======================================================

</script>
</body>
</html>