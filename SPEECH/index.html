<!DOCTYPE html>
<meta charset="utf-8">
<title>テキスト読上と音声認識</title>
<meta name=viewport content="width=device-width,user-scalable=no">
<style>
	*{margin:0;padding:0;
		font-size:20px;
		list-style:none;
		box-sizing:border-box;
	}
	::-webkit-scrollbar{display:none;}
	#input{width:100%;height:5em;padding:5px;display:block;}
	h1{font-size:1.5em;text-align:center;}
	p{margin:0.1em;}
	li{margin-left:0.1em;}
	button,select{
		border-radius:5px;
		height:2em;
		border:1px solid gray;
		background-color:#eee;
		padding:0 0.5em;
	}
	#wrap{
		width:500px;
		overflow:hidden;
	}
	section{
		border:1px solid gray;
		margin:1px;
	}
	#flex{
		display:flex;
	}
	#flex section{flex:1;}
</style>

<div id=wrap>
	<h1>テキスト読上と音声認識</h1>
	<section>
		<h1>共通設定</h1>
		<ol>
			<li>
				<p>1.  音声の種類を選択する→ <span id=voices><button onclick="voice();">選択</button></p>
			</li>
			<li>
				<p>2. 言語を選択する→ <select id=lang>
					<option value="ja-JP" selected>日本語</option>
					<option value="en-US">英語</option>
				</select>
			</li>
		</ol>
	</section>
	<div id=flex>
		<section>
			<h1>テキスト読上</h1>
			<ol>
				<li>
					<p>3. テキストを入力する：	
					<p><textarea id=input>
こんにちは。みなさん。
					</textarea></p>
				</li>
				<li>
					<p><button onclick="mySpeech();">4. テキスト読上</button></p>
				</li>
			</ol>
		</section>
		<section>
			<ol>
				<h1>音声認識</h1>
				<li>
					<p>3. <button onclick="nyuryoku();">ボタンを押して</button>
				</li>
				<li>
					<p>4. マイクから音声を入力する</p>
				</li>
		
			</ol>
		</section>
	</div>
</div>

<script>

	//ボイスの種類

	var voices = speechSynthesis.getVoices();
	
	function voice(){
		voices = speechSynthesis.getVoices();
		var length=voices.length;
		var voiceStr="<select id=voice>";
		console.log(length);
		
		for(var i=0;i<length;i++){
			if(voices[i]){
				if(voices[i].name==="Google 日本語"){var sel="selected"}else{var sel=""};
				voiceStr+="<option value="+i+" "+sel+">"+voices[i].name+"</option>";
				
			}
		}
		voiceStr+="</select>";
		
		$id("voices").innerHTML=voiceStr;

	}

	//テキスト読み上げ
	function mySpeech(){
		var input = $id("input").value;
		var voice = parseInt($id("voice").value);
		var input = new SpeechSynthesisUtterance(input);
		var lang = $id("lang").value
		input.lang = lang;
		var voices = speechSynthesis.getVoices();
		input.voice = voices[voice];
		speechSynthesis.speak(input);
	}

	//音声認識
	function nyuryoku(){
		var recognition = new webkitSpeechRecognition();	//音声認識オブジェクト生成
		recognition.lang = $id("lang").value;	//言語設定
		recognition.start();	//認識開始
		// 終了時トリガー
		recognition.addEventListener('result', function(e){
			var rec = e.results.item(0).item(0).transcript;	//文字列抽出
			
			//認識文字列を加工
			//①文字を書き換え
			rec=rec.replace("中島","イケメン中島");
			rec=rec.replace("なかしま","イケメン中島");
			//②時間を回答
			var now=new Date();
			rec=rec.replace("何時",now.getHours()+"時"+now.getMinutes()+"分です");

			$id("input").value=	rec;
			setTimeout(mySpeech,1000);	//1秒後にmySpeechを起動
		});
	}
	
	function $id(id){return document.getElementById(id);}
</script>
